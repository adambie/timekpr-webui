<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeKpr webUI Dashboard</title>
	<link rel="icon" type="image/png" href="{{ url_for('static', filename='timekpr-client-128.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body class="dashboard-body">
    <div class="dashboard-container">
		<header class="dashboard-header">
			<div>
				<img src="{{ url_for('static', filename='timekpr-client-128.png') }}"/>
			</div>
			
            <h1>TimeKpr webUI Dashboard</h1>

			<div class="user-controls">
			    <div class="task-status-container">
			        <span class="task-status">
			            Background Tasks: <span id="task-status-indicator" class="status-unknown">Unknown</span>
			        </span>
			        <a href="{{ url_for('restart_tasks') }}" class="btn btn-sm btn-restart" title="Restart Background Tasks">
			            <span class="restart-icon">â†»</span>
			        </a>
			    </div>
			    <a href="{{ url_for('admin') }}" class="btn btn-sm btn-admin">Admin</a>
			    <a href="{{ url_for('settings') }}" class="btn btn-sm btn-settings">Settings</a>
			    <a href="{{ url_for('logout') }}" class="btn btn-sm btn-logout">Logout</a>
			</div>
		</header>

		        
        <script>
            // Function to update the task status indicator
            function updateTaskStatus() {
                fetch('{{ url_for('get_task_status') }}')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const indicator = document.getElementById('task-status-indicator');
                            const status = data.status;
                            
                            if (status.running && status.thread_alive) {
                                indicator.className = 'status-active';
                                indicator.textContent = 'Active';
                            } else {
                                indicator.className = 'status-inactive';
                                indicator.textContent = 'Inactive';
                            }
                            
                            // Set tooltip to show last error if any
                            if (status.last_error) {
                                indicator.title = `Last error: ${status.last_error.message} at ${status.last_error.time}`;
                            } else {
                                indicator.title = 'Background tasks are running normally';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching task status:', error);
                        const indicator = document.getElementById('task-status-indicator');
                        indicator.className = 'status-error';
                        indicator.textContent = 'Error';
                    });
            }
            
            // Check status immediately and then every 30 seconds
            updateTaskStatus();
            setInterval(updateTaskStatus, 30000);
        </script>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="user-grid">
            {% if users %}
                {% for user in users %}
                    <div class="user-tile">
                        <div class="user-tile-header">
                            <h2>{{ user.username }}</h2>
                            <div class="user-location">{{ user.system_ip }}</div>
                        </div>
                        <div class="user-tile-info">
                            <div class="info-item">
                                <div class="info-label">Time Left Today:</div>
                                <div class="info-value">{{ user.time_left }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Last Updated:</div>
                                <div class="info-value">
                                    {% if user.last_checked %}
                                        {{ user.last_checked.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        Never
                                    {% endif %}
                                </div>
                            </div>
                            {% if user.id|string in pending_adjustments %}
                            <div class="info-item pending-item">
                                <div class="info-label">Pending Time Adjustment:</div>
                                <div class="info-value pending-value">
                                    {{ pending_adjustments[user.id|string] }}
                                </div>
                            </div>
                            {% endif %}
                            <div class="info-item action-item">
                                <button class="btn btn-adjust-time" onclick="openTimeAdjustModal({{ user.id }}, '{{ user.username }}')">Adjust Time</button>
                            </div>
                        </div>
                        <div class="user-tile-chart">
                            <h3>Time Usage (Last 7 Days)</h3>
                            <canvas id="chart-{{ user.id }}" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <script>
                        (function() {
                            const ctx = document.getElementById('chart-{{ user.id }}').getContext('2d');
                            
                            // Prepare data
                            const labels = [];
                            const values = [];
                            
                            {% for date, time_spent in user.usage_data.items() %}
                                labels.push('{{ date }}');
                                values.push({{ time_spent / 3600 }});  // Convert seconds to hours
                            {% endfor %}
                            
                            const chart = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Hours Used',
                                        data: values,
                                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                        borderColor: 'rgba(54, 162, 235, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            title: {
                                                display: true,
                                                text: 'Hours'
                                            }
                                        },
                                        x: {
                                            title: {
                                                display: true,
                                                text: 'Date'
                                            }
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: false
                                        }
                                    },
                                    maintainAspectRatio: false
                                }
                            });
                        })();
                    </script>
                {% endfor %}
            {% else %}
                <div class="empty-state full-width">
                    <h2>No Users Available</h2>
                    <p>No valid users have been added yet. Go to the Admin Panel to add and manage users.</p>
                    <a href="{{ url_for('admin') }}" class="btn btn-admin">Go to Admin Panel</a>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Time Adjustment Modal -->
    <div id="timeAdjustModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Adjust Time for <span id="modalUsername"></span></h2>
                <span class="close-modal" onclick="closeTimeAdjustModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Current adjustment: <span id="timeAdjustment">0</span> minutes</p>
                
                <div class="time-controls">
					<button class="btn btn-time-adjust" onclick="adjustTime(-15)">-15m</button>
					<button class="btn btn-time-adjust" onclick="adjustTime(-10)">-10m</button>
                    <button class="btn btn-time-adjust btn-reset" onclick="resetTime()">Reset</button>
					<button class="btn btn-time-adjust" onclick="adjustTime(10)">+10m</button>
                    <button class="btn btn-time-adjust" onclick="adjustTime(15)">+15m</button>
                </div>
                
                <div class="modal-footer">
                    <div id="modalStatus" class="modal-status"></div>
                    <button class="btn btn-cancel" onclick="closeTimeAdjustModal()">Cancel</button>
                    <button class="btn btn-confirm" onclick="submitTimeAdjustment()">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Time adjustment modal variables
        let currentUserId = null;
        let currentUsername = '';
        let timeAdjustment = 0; // in minutes
        
        // Function to open the time adjustment modal
        function openTimeAdjustModal(userId, username) {
            currentUserId = userId;
            currentUsername = username;
            document.getElementById('modalUsername').textContent = username;
            resetTime();
            document.getElementById('timeAdjustModal').style.display = 'block';
        }
        
        // Function to close the modal
        function closeTimeAdjustModal() {
            document.getElementById('timeAdjustModal').style.display = 'none';
            document.getElementById('modalStatus').textContent = '';
            document.getElementById('modalStatus').className = 'modal-status';
        }
        
        // Function to adjust time
        function adjustTime(minutes) {
            timeAdjustment += minutes;
            updateTimeDisplay();
        }
        
        // Function to reset time adjustment
        function resetTime() {
            timeAdjustment = 0;
            updateTimeDisplay();
        }
        
        // Function to update the time display
        function updateTimeDisplay() {
            const display = document.getElementById('timeAdjustment');
            display.textContent = timeAdjustment;
            
            // Update color based on value
            if (timeAdjustment > 0) {
                display.className = 'time-positive';
            } else if (timeAdjustment < 0) {
                display.className = 'time-negative';
            } else {
                display.className = '';
            }
        }
        
        // Function to submit the time adjustment
        function submitTimeAdjustment() {
            if (timeAdjustment === 0) {
                alert('No time adjustment specified');
                return;
            }
            
            const seconds = timeAdjustment * 60; // Convert minutes to seconds
            
            // Show loading status
            const statusEl = document.getElementById('modalStatus');
            statusEl.textContent = 'Applying changes...';
            statusEl.className = 'modal-status status-loading';
            
            // Create form data
            const formData = new FormData();
            formData.append('user_id', currentUserId);
            formData.append('seconds', seconds);
            
            // Send request to server
			fetch('{{ url_for('modify_time') }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusEl.textContent = 'Success! Time adjusted successfully.';
                    statusEl.className = 'modal-status status-success';
                    
                    // Refresh the page after 1.5 seconds
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    statusEl.textContent = `Error: ${data.message}`;
                    statusEl.className = 'modal-status status-error';
                }
            })
            .catch(error => {
                statusEl.textContent = `Error: ${error.message}`;
                statusEl.className = 'modal-status status-error';
            });
        }
    </script>
</body>
</html>